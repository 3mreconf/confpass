name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  build-tauri:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      msi-artifact-id: ${{ steps.upload-msi.outputs.artifact-id }}
      nsis-artifact-id: ${{ steps.upload-nsis.outputs.artifact-id }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: install frontend dependencies
        run: npm install

      - name: Get version
        id: get_version
        shell: pwsh
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV

      - name: Build Tauri app
        run: npm run tauri build -- --target x86_64-pc-windows-msvc
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""

      - name: Upload unsigned MSI
        id: upload-msi
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-msi
          path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi

      - name: Upload unsigned NSIS
        id: upload-nsis
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-nsis
          path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe

  sign-msi:
    needs: build-tauri
    runs-on: ubuntu-latest
    outputs:
      signed-artifact-id: ${{ steps.sign.outputs.signed-artifact-id }}
    steps:
      - name: Sign MSI with SignPath
        id: sign
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
          project-slug: confpass
          signing-policy-slug: confpass
          artifact-configuration-slug: msi
          github-artifact-id: ${{ needs.build-tauri.outputs.msi-artifact-id }}
          wait-for-completion: true
          output-artifact-directory: ./signed-msi

      - name: Upload signed MSI
        uses: actions/upload-artifact@v4
        with:
          name: signed-msi
          path: ./signed-msi/*

  sign-nsis:
    needs: build-tauri
    runs-on: ubuntu-latest
    outputs:
      signed-artifact-id: ${{ steps.sign.outputs.signed-artifact-id }}
    steps:
      - name: Sign NSIS with SignPath
        id: sign
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
          project-slug: confpass
          signing-policy-slug: confpass
          artifact-configuration-slug: exe
          github-artifact-id: ${{ needs.build-tauri.outputs.nsis-artifact-id }}
          wait-for-completion: true
          output-artifact-directory: ./signed-nsis

      - name: Upload signed NSIS
        uses: actions/upload-artifact@v4
        with:
          name: signed-nsis
          path: ./signed-nsis/*

  create-release:
    needs: [build-tauri, sign-msi, sign-nsis]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download signed MSI
        uses: actions/download-artifact@v4
        with:
          name: signed-msi
          path: ./release-assets

      - name: Download signed NSIS
        uses: actions/download-artifact@v4
        with:
          name: signed-nsis
          path: ./release-assets

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ConfPass v${{ needs.build-tauri.outputs.version }}
          body: |
            ## ConfPass v${{ needs.build-tauri.outputs.version }}

            ### Downloads
            - **MSI Installer** - Recommended for most users
            - **EXE Installer** - NSIS installer alternative

            ### Verification
            All artifacts are code-signed with SignPath.io
          draft: false
          prerelease: false
          files: ./release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
